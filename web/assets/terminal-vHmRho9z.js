const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CRn00pAv.js","assets/svelte-V7cO9hUs.js","assets/vendor-CPGM4lnp.js","assets/index-peCwbNZe.css"])))=>i.map(i=>d[i]);
import{p as e,d as t,l as n,t as s,_ as i,e as o,j as r}from"./index-CRn00pAv.js";import{w as a,g as c,d as l}from"./svelte-V7cO9hUs.js";import"./vendor-CPGM4lnp.js";const d=32768,u="[38;5;46m\r\n  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—\r\n  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•\r\n  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â•šâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘\r\n  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•   â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘\r\n  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—\r\n  â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â•\r\n[0m[38;5;243m  Terminal as a Service Â· rexec.dev[0m\r\n[38;5;243m  Run 'rexec tools' to see available tools[0m\r\n\r\n";function f(e){return t=>{if("keydown"!==t.type)return!0;const n="undefined"!=typeof navigator&&navigator.platform||"",s="undefined"!=typeof navigator?navigator.userAgent:"",i=/Mac|iPod|iPhone|iPad/.test(n)||/Macintosh/.test(s),o=/Firefox/.test(s),r=/Safari/.test(s)&&!/Chrome/.test(s);if(o&&"Backquote"===t.code&&!t.ctrlKey&&!t.metaKey&&!t.altKey)return!0;if(t.ctrlKey&&!t.altKey&&!t.metaKey&&!t.shiftKey){const n=t.key.toLowerCase();if(["s","p","f","r","o","g","b","h","i","u","l","k","j"].includes(n))return t.preventDefault(),!0;if("c"===n){if(e.hasSelection()){const n=e.getSelection();return n&&navigator.clipboard.writeText(n).catch(()=>{}),t.preventDefault(),!1}return t.preventDefault(),!0}}if(r&&t.ctrlKey&&["a","e","k","u","w"].includes(t.key.toLowerCase()))return t.preventDefault(),!0;if(i&&t.metaKey&&!t.ctrlKey&&!t.altKey&&!t.shiftKey){const n=t.key.toLowerCase();if("c"===n){if(e.hasSelection()){const n=e.getSelection();return n&&navigator.clipboard.writeText(n).catch(()=>{}),t.preventDefault(),!1}return t.preventDefault(),t.stopPropagation(),e.input(""),!1}if("v"===n||"x"===n||"a"===n)return!0;if(["d","t","w","n","enter"].includes(n))return!1;if("q"===n)return!1;if(1===n.length&&n>="a"&&n<="z"){const s=n.charCodeAt(0)-96;return t.preventDefault(),t.stopPropagation(),e.input(String.fromCharCode(s)),!1}}return!(!i&&t.altKey&&!t.ctrlKey&&!t.metaKey)||!["F4","Tab"].includes(t.key)}}function m(){if("undefined"==typeof window)return 11;const e=window.innerWidth;return e<768?10:e<1200?11:12}let p=m();const g={background:"#0a0a0a",foreground:"#e0e0e0",cursor:"#00ff41",cursorAccent:"#0a0a0a",selectionBackground:"rgba(0, 255, 65, 0.3)",selectionForeground:"#ffffff",selectionInactiveBackground:"rgba(0, 255, 65, 0.15)",black:"#0a0a0a",red:"#ff003c",green:"#00ff41",yellow:"#fcee0a",blue:"#00a0dc",magenta:"#ff00ff",cyan:"#00ffff",white:"#e0e0e0",brightBlack:"#666666",brightRed:"#ff5555",brightGreen:"#55ff55",brightYellow:"#ffff55",brightBlue:"#5555ff",brightMagenta:"#ff55ff",brightCyan:"#55ffff",brightWhite:"#ffffff"},h={background:"#ffffff",foreground:"#1a1a1a",cursor:"#00a830",cursorAccent:"#ffffff",selectionBackground:"rgba(0, 168, 48, 0.3)",selectionForeground:"#1a1a1a",selectionInactiveBackground:"rgba(0, 168, 48, 0.15)",black:"#1a1a1a",red:"#dc2626",green:"#00a830",yellow:"#ca8a04",blue:"#2563eb",magenta:"#9333ea",cyan:"#0891b2",white:"#e5e5e5",brightBlack:"#737373",brightRed:"#ef4444",brightGreen:"#22c55e",brightYellow:"#eab308",brightBlue:"#3b82f6",brightMagenta:"#a855f7",brightCyan:"#06b6d4",brightWhite:"#ffffff"};function w(){return"light"===c(o)?h:g}const S={cursorBlink:!0,cursorStyle:"bar",cursorWidth:2,fontSize:p,fontFamily:'"JetBrains Mono", "Fira Code", "SF Mono", Menlo, Monaco, "Courier New", monospace',fontWeight:"400",fontWeightBold:"600",letterSpacing:0,lineHeight:1.2,theme:w(),allowProposedApi:!0,scrollback:1e5,fastScrollModifier:"alt",fastScrollSensitivity:20,scrollSensitivity:3,smoothScrollDuration:0,windowsMode:!1,convertEol:!1,rightClickSelectsWord:!0,drawBoldTextInBrightColors:!0,minimumContrastRatio:1,rescaleOverlappingGlyphs:!0,scrollOnUserInput:!0,altClickMovesCursor:!0,macOptionIsMeta:!0,macOptionClickForcesSelection:!0,screenReaderMode:!1,bellStyle:"none",tabStopWidth:8},y={sessions:new Map,activeSessionId:null,viewMode:"floating",isMinimized:!1,floatingPosition:{x:100,y:100},floatingSize:{width:700,height:500},dockedHeight:45,topZIndex:1e3};function b(){if("undefined"==typeof window)return{};try{const e=localStorage.getItem("rexec_terminal_prefs");if(e){const t=JSON.parse(e);return{viewMode:t.viewMode||"floating",floatingPosition:t.floatingPosition||y.floatingPosition,floatingSize:t.floatingSize||y.floatingSize,dockedHeight:t.dockedHeight||y.dockedHeight}}}catch(e){}return{}}function v(e){try{localStorage.setItem("rexec_terminal_prefs",JSON.stringify({viewMode:e.viewMode,floatingPosition:e.floatingPosition,floatingSize:e.floatingSize,dockedHeight:e.dockedHeight}))}catch(t){}}function I(){return`${"https:"===window.location.protocol?"wss:":"ws:"}//${window.location.host}`}const P=function(){const o={...y,...b()},{subscribe:l,update:P}=a(o),A=()=>{let e;return l(t=>e=t)(),e},k=(e,t)=>{P(n=>{const s=n.sessions.get(e);if(s){const i=new Map(n.sessions);return i.set(e,t(s)),{...n,sessions:i}}return n})};return{subscribe:l,getState:A,async createSession(e,t){const n=A();if(!e)return null;const s=t&&"string"==typeof t?t:`Terminal-${e.slice(0,8)}`;if(!c(r))return null;const i=Array.from(n.sessions.values()).find(t=>t.containerId===e);return i?(P(e=>({...e,activeSessionId:i.id})),this.updateUrl(e),i.id):await this.createNewTab(e,s)},async createNewTab(e,t){if(!c(r))return null;if(!e)return null;const i=t&&"string"==typeof t?t:`Terminal-${e.slice(0,8)}`,o=A(),a=Array.from(o.sessions.values()).filter(t=>t.containerId===e).length,l=`session-${Date.now()}-${Math.random().toString(36).slice(2,9)}`,d={id:l,containerId:e,name:a>0?`${i} (${a+1})`:i,terminal:null,fitAddon:null,webglAddon:null,ws:null,status:"connecting",reconnectAttempts:0,reconnectTimer:null,pingInterval:null,resizeObserver:null,isSettingUp:!1,setupMessage:"",hasConnectedOnce:!1,isAgentSession:!1,agentId:null,isCollabSession:!1,collabMode:null,collabRole:null,stats:{cpu:0,memory:0,memoryLimit:0,diskRead:0,diskWrite:0,diskLimit:0,netRx:0,netTx:0},isDetached:!1,detachedPosition:{x:150,y:150},detachedSize:{width:600,height:400},detachedZIndex:1e3,splitPanes:new Map,splitLayout:null,activePaneId:null};P(e=>{const t=new Map(e.sessions);return t.set(l,d),{...e,sessions:t,activeSessionId:l,isMinimized:!1}}),this.updateUrl(e);return(()=>{this.connectWebSocket(l)})(),(async()=>{let e,t,i,o,r,a;try{({Terminal:e,FitAddon:t,Unicode11Addon:i,WebLinksAddon:o}=await n())}catch(c){return s.error("Failed to load terminal. Please refresh and try again."),this.closeSession(l),!1}try{const n={...S,theme:w()};r=new e(n),a=new t,r.loadAddon(a),r.loadAddon(new o);const s=new i;r.loadAddon(s),r.unicode.activeVersion="11",r.attachCustomKeyEventHandler(f(r))}catch(c){return s.error("Failed to initialize terminal. Please try again."),this.closeSession(l),!1}return k(l,e=>({...e,terminal:r,fitAddon:a})),!0})().catch(e=>{}),l},async createCollabSession(e,t,n,s){const i=await this.createSession(e,t);return i?(k(i,e=>({...e,isCollabSession:!0,collabMode:n,collabRole:s})),i):null},async createAgentSession(e,t){if(!c(r))return null;const n=await this.createNewTab(`agent:${e}`,`[Agent] ${t}`);return n?(k(n,t=>({...t,isAgentSession:!0,agentId:e})),n):null},updateUrl(e){const t=`/terminal/${e}`;window.location.pathname!==t&&window.history.pushState({containerId:e},"",t)},clearUrl(){"/"!==window.location.pathname&&window.history.pushState({},"","/")},connectWebSocket(e){const n=A().sessions.get(e);if(!n)return;const s=c(r);if(!s)return;if(n.ws&&(n.ws.readyState===WebSocket.OPEN||n.ws.readyState===WebSocket.CONNECTING))return;n.reconnectTimer&&clearTimeout(n.reconnectTimer),n.pingInterval&&clearInterval(n.pingInterval);const o=n.agentId||(n.containerId.startsWith("agent:")?n.containerId.slice(6):null);let a;if(n.isAgentSession||o){if(!o)return;a=`${I()}/ws/agent/${encodeURIComponent(o)}/terminal?id=${encodeURIComponent(e)}`}else a=`${I()}/ws/terminal/${encodeURIComponent(n.containerId)}?id=${encodeURIComponent(e)}`;const l=t(a,s);k(e,e=>({...e,ws:l,status:"connecting"}));const f=()=>A().sessions.get(e),m=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?15e3:8e3,p=(e,t=m)=>{const n=Date.now(),s=()=>{const i=f();i?.terminal?e(i.terminal):Date.now()-n<t&&setTimeout(s,50)};s()};l.onopen=()=>{const t=f(),n=!0===t?.hasConnectedOnce;k(e,e=>({...e,status:"connected",reconnectAttempts:0,hasConnectedOnce:!0})),p(e=>{const t=f();if(t){try{t.fitAddon?.fit()}catch(s){}l.send(JSON.stringify({type:"resize",cols:e.cols||80,rows:e.rows||24})),n?(e.writeln("\r\n[32mâ€º Reconnected[0m\r\n"),l.send(JSON.stringify({type:"input",data:"\f"}))):(e.clear(),e.write("[0m[?25h[H[2J"),e.write(u),e.writeln("[32mâ€º Connected[0m"),e.writeln("[38;5;243m  Type 'help' for tips & shortcuts Â· Ctrl+C to interrupt[0m"))}});const s=f();s?.terminal||l.send(JSON.stringify({type:"resize",cols:80,rows:24}));const i=setInterval(()=>{l.readyState===WebSocket.OPEN&&l.send(JSON.stringify({type:"ping"}))},2e4);k(e,e=>({...e,pingInterval:i}))};let g="",h=null,w=null,S=0,y=!1;const b=e=>{let t=e.replace(/\x1b\[<\d+;\d+;\d+[Mm]/g,"");return t=t.replace(/\x1b\]\d+;[^\x07\x1b]*(?:\x07|\x1b\\)/g,""),t=t.replace(/\]\d+;rgb:[0-9a-f/]+/gi,""),t},v=()=>{const e=f();if(g&&e?.terminal){y||(y=!0,e.terminal.write("\r[K\r\n"));const t=b(g);t&&e.terminal.write(t),g="",S=performance.now()}else if(g&&!e?.terminal)return void setTimeout(v,50);h=null,w=null},P=()=>{if(h)return;performance.now()-S>8?(w=requestAnimationFrame(()=>{h&&(clearTimeout(h),h=null),v()}),h=setTimeout(()=>{w&&(cancelAnimationFrame(w),w=null),v()},50)):h=setTimeout(()=>{v()},8)};l.onmessage=async t=>{let s=t.data;s instanceof Blob&&(s=await s.text());try{const t=JSON.parse(s);if("output"===t.type){const n=t.data,s=n.match(/\[\[REXEC_STATUS\]\](.*)/);if(s){const t=s[1].trim();if("Setup complete."===t){k(e,e=>({...e,isSettingUp:!1,setupMessage:""}));const t=f();t?.ws?.readyState===WebSocket.OPEN&&t.terminal&&(t.terminal.writeln("\r\n[32mâœ“ Environment ready! Press Enter for a fresh prompt.[0m\r\n"),t.ws.send(JSON.stringify({type:"input",data:"\n"})))}else k(e,e=>({...e,isSettingUp:!0,setupMessage:t}));const i=n.replace(/\[\[REXEC_STATUS\]\].*\n?/g,"");return void(i&&(g+=i,g.length>=d?(h&&clearTimeout(h),w&&cancelAnimationFrame(w),v()):P()))}if(n.length<=256)return void(e=>{const t=f();if(t?.terminal){y||(y=!0,t.terminal.write("\r[K\r\n"));const n=b(e);n&&t.terminal.write(n)}else g+=e})(n);if([/installing/i,/setting up/i,/configuring/i,/downloading/i,/unpacking/i,/processing/i].some(e=>e.test(n))){const t=n.split("\n").filter(e=>e.trim()),s=t[t.length-1]||"",i=s.slice(0,50)+(s.length>50?"...":"");k(e,e=>({...e,isSettingUp:!0,setupMessage:i})),k(e,e=>({...e,isSettingUp:!1,setupMessage:""}))}g+=n,g.length>=d?(h&&clearTimeout(h),w&&cancelAnimationFrame(w),v()):P()}else if("error"===t.type){const e=f();e?.terminal&&e.terminal.writeln(`\r\n[31mError: ${t.data}[0m`)}else if("ping"===t.type)l.send(JSON.stringify({type:"pong"}));else if("setup"===t.type)k(e,e=>({...e,isSettingUp:!0,setupMessage:t.message||"Setting up environment..."}));else if("setup_complete"===t.type)k(e,e=>({...e,isSettingUp:!1,setupMessage:""}));else if("shell_ready"===t.type||"shell_started"===t.type)k(e,e=>({...e,status:"connected"}));else if("stats"===t.type)try{const n="string"==typeof t.data?JSON.parse(t.data):t.data;k(e,e=>({...e,stats:{cpu:n.cpu_percent||0,memory:n.memory||0,memoryLimit:n.memory_limit||0,diskRead:n.disk_read||0,diskWrite:n.disk_write||0,diskUsage:n.disk_usage||0,diskLimit:n.disk_limit||0,netRx:n.net_rx||0,netTx:n.net_tx||0}}))}catch(o){}else if("container_status"===t.type){const e=t.data;i(async()=>{const{containers:e}=await import("./index-CRn00pAv.js").then(e=>e.v);return{containers:e}},__vite__mapDeps([0,1,2,3])).then(({containers:t})=>{t.update(t=>{const s=t.containers.findIndex(e=>e.id===n.containerId||e.db_id===n.containerId);if(s>=0){const n=t.containers[s];if(n.status!==e){const i=[...t.containers];return i[s]={...n,status:e},{...t,containers:i}}}return t})}).catch(()=>{})}else if("shell_starting"===t.type){const e=f();e?.terminal&&e.terminal.write("[38;5;243mâ€º Starting shell...[0m")}else if("shell_started"===t.type);else if("shell_stopped"===t.type){const e=f();e?.terminal&&e.terminal.writeln("\r\n[33mâ€º Shell session ended[0m")}else if("shell_error"===t.type){const e=t.data,n=e?.error||"Shell error",s=f();s?.terminal&&s.terminal.writeln(`\r\n[31mâ€º Error: ${n}[0m`)}}catch{g+=s,g.length>=d?(h&&clearTimeout(h),w&&cancelAnimationFrame(w),v()):P()}},l.onclose=t=>{const n=A().sessions.get(e);if(!n)return;n.pingInterval&&clearInterval(n.pingInterval);const s=1e3===t.code,i=4100===t.code,o=t.code>=4e3&&4100!==t.code,r=n.reconnectAttempts>=15;if(i)return n.terminal&&n.terminal.writeln("\r\n[33mâŸ³ Container restarting, reconnecting...[0m"),void this.refreshContainerAndReconnect(e,n.containerId);if(!s&&!o&&!r){const t=n.reconnectAttempts+1,s=100,i=1===t?0:Math.min(s*Math.pow(1.5,n.reconnectAttempts-1),8e3);k(e,e=>({...e,status:"connecting",reconnectAttempts:t})),t>3&&n.terminal&&n.terminal.writeln(`\r\n[33mâŸ³ Reconnecting (${t}/15)...[0m`);const o=setTimeout(()=>{this.connectWebSocket(e)},i);k(e,e=>({...e,reconnectTimer:o}))}else k(e,e=>({...e,status:"disconnected"})),o?(n.terminal&&n.terminal.writeln("\r\n[31mâœ– Terminal session ended. Terminal may have been stopped or removed.[0m"),k(e,e=>({...e,status:"error"}))):r&&(n.terminal&&n.terminal.writeln("\r\n[31mâœ– Connection lost after multiple attempts. Click [33mâŸ³[31m to reconnect.[0m"),k(e,e=>({...e,status:"error"})))},l.onerror=()=>{};let z=[],O=!1;const T=32768;p(t=>{t.onData(t=>{if(l.readyState!==WebSocket.OPEN)return;const n=A().sessions.get(e);if(!n?.isCollabSession||"view"!==n?.collabMode)if(t.length>T){for(let e=0;e<t.length;e+=T)z.push(t.slice(e,e+T));(async()=>{if(!O&&0!==z.length){for(O=!0;z.length>0&&l.readyState===WebSocket.OPEN;){const e=z.shift();l.send(JSON.stringify({type:"input",data:e})),z.length>0&&await new Promise(e=>setTimeout(e,10))}O=!1}})()}else l.send(JSON.stringify({type:"input",data:t}))}),t.onBinary(e=>{l.readyState===WebSocket.OPEN&&l.send(JSON.stringify({type:"input",data:e}))})})},resetSession(e){const t=A().sessions.get(e);if(t&&t.terminal){try{t.fitAddon.fit()}catch(n){}t.terminal.write("c"),t.terminal.clear(),t.terminal.write(u),t.terminal.writeln("[32mâ€º Terminal Reset[0m"),t.ws&&t.ws.readyState===WebSocket.OPEN&&t.ws.send(JSON.stringify({type:"resize",cols:t.terminal.cols,rows:t.terminal.rows})),s.success("Terminal reset")}},reconnectSession(e){const t=A().sessions.get(e);t?.ws&&t.ws.close(),k(e,e=>({...e,reconnectAttempts:0,status:"connecting"})),this.connectWebSocket(e)},async refreshContainerAndReconnect(e,t){const n=c(r);if(n)try{const s=await fetch(`/api/containers/${t}/start`,{method:"POST",headers:{Authorization:`Bearer ${n}`}});if(s.ok){const n=(await s.json()).id||t;k(e,n!==t?e=>({...e,containerId:n,reconnectAttempts:0,status:"connecting"}):e=>({...e,reconnectAttempts:0,status:"connecting"})),this.connectWebSocket(e)}else{const t=A().sessions.get(e);t&&t.terminal.writeln("\r\n[31mâœ– Failed to restart container. Please try again.[0m"),k(e,e=>({...e,status:"error"}))}}catch(s){k(e,e=>({...e,status:"error"}))}},updateSessionContainerId(e,t){const n=A(),s=[],i=[];for(const[o,r]of n.sessions)r.containerId===e&&(s.push(o),r.splitPanes.forEach((e,t)=>{e.ws&&e.ws.close(),i.push({sessionId:o,paneId:t})}),r.ws&&r.ws.close());0!==s.length&&(s.forEach(e=>{k(e,e=>({...e,containerId:t,status:"connecting",reconnectAttempts:0}))}),s.forEach(e=>{this.connectWebSocket(e)}),i.forEach(({sessionId:e,paneId:t})=>{this.connectSplitPaneWebSocket(e,t)}))},closeSession(e){const t=A().sessions.get(e);t&&(t.ws&&t.ws.close(),t.pingInterval&&clearInterval(t.pingInterval),t.reconnectTimer&&clearTimeout(t.reconnectTimer),t.resizeObserver&&t.resizeObserver.disconnect(),t.webglAddon&&t.webglAddon.dispose(),t.terminal&&t.terminal.dispose(),P(t=>{const n=new Map(t.sessions);n.delete(e);let s=null;if(t.activeSessionId===e){const e=Array.from(n.values()).filter(e=>!e.isDetached);s=e.length>0?e[e.length-1].id:null}else s=t.activeSessionId;if(s){const e=n.get(s);e&&this.updateUrl(e.containerId)}else this.clearUrl();return{...t,sessions:n,activeSessionId:s}}))},closeAllSessions(){A().sessions.forEach((e,t)=>{e.isDetached||this.closeSession(t)});0===A().sessions.size&&this.clearUrl()},closeAllSessionsForce(){A().sessions.forEach((e,t)=>this.closeSession(t)),this.clearUrl()},setActiveSession(e){const t=A().sessions.get(e);t&&this.updateUrl(t.containerId),P(t=>({...t,activeSessionId:e}))},setViewMode(e){P(t=>{const n={...t,viewMode:e};return v(n),n})},toggleViewMode(){const e=A();this.setViewMode("floating"===e.viewMode?"docked":"floating")},toggleFloating(){this.toggleViewMode()},toggleFullscreen(){"fullscreen"===A().viewMode?this.setViewMode("docked"):this.setViewMode("fullscreen")},minimize(){P(e=>({...e,isMinimized:!0}))},restore(){P(e=>({...e,isMinimized:!1}))},setFloatingPosition(e,t){P(n=>{const s={...n,floatingPosition:{x:e,y:t}};return v(s),s})},setFloatingSize(e,t){P(n=>{const s={...n,floatingSize:{width:e,height:t}};return v(s),s})},setDockedHeight(e){P(t=>{const n={...t,dockedHeight:Math.max(20,Math.min(90,e))};return v(n),n})},fitAll(){A().sessions.forEach(e=>{try{e.fitAddon.fit(),e.ws?.readyState===WebSocket.OPEN&&e.ws.send(JSON.stringify({type:"resize",cols:e.terminal.cols,rows:e.terminal.rows}))}catch(t){}})},fitSession(e){const t=A().sessions.get(e);if(t)try{t.fitAddon.fit(),t.ws?.readyState===WebSocket.OPEN&&t.ws.send(JSON.stringify({type:"resize",cols:t.terminal.cols,rows:t.terminal.rows}))}catch(n){}},updateFontSize(){const e=m();this.setFontSize(e)},setFontSize(e){p=Math.max(8,Math.min(24,e));A().sessions.forEach(e=>{try{e.terminal.options.fontSize=p,e.fitAddon.fit(),e.splitPanes.forEach(e=>{e.terminal.options.fontSize=p,e.fitAddon.fit()})}catch(t){}})},zoomIn(){this.setFontSize(p+1)},zoomOut(){this.setFontSize(p-1)},resetZoom(){this.setFontSize(m())},getFontSize:()=>p,updateTheme(e){const t=e?g:h;A().sessions.forEach(e=>{e.terminal.options.theme=t,e.terminal.refresh(0,e.terminal.rows-1),e.splitPanes.forEach(e=>{e.terminal.options.theme=t,e.terminal.refresh(0,e.terminal.rows-1)})})},attachTerminal(t,n){const s=A().sessions.get(t);if(s&&n){if(s.resizeObserver&&s.resizeObserver.disconnect(),s.terminal.open(n),n.addEventListener("paste",e=>{if(!e.target.classList.contains("xterm-helper-textarea"))return;const t=e.clipboardData?.getData("text");if(t&&s.ws?.readyState===WebSocket.OPEN){const n=32768;if(t.length>n){e.preventDefault();const i=[];for(let e=0;e<t.length;e+=n)i.push(t.slice(e,e+n));let o=0;const r=()=>{o<i.length&&s.ws?.readyState===WebSocket.OPEN&&(s.ws.send(JSON.stringify({type:"input",data:i[o]})),o++,o<i.length&&setTimeout(r,10))};r()}}}),e().then(({WebglAddon:e})=>{const n=A().sessions.get(t);if(n&&!n.webglAddon)try{const s=new e;s.onContextLoss(()=>{s.dispose(),k(t,e=>({...e,webglAddon:null}))}),n.terminal.loadAddon(s),k(t,e=>({...e,webglAddon:s}))}catch(s){}}).catch(()=>{}),window.ResizeObserver){let e=null;const s=new ResizeObserver(()=>{e&&clearTimeout(e),e=setTimeout(()=>{this.fitSession(t)},50)});s.observe(n),k(t,e=>({...e,resizeObserver:s}))}requestAnimationFrame(()=>this.fitSession(t))}},reattachTerminal(e,t){const n=A().sessions.get(e);if(!n||!t)return;n.resizeObserver&&n.resizeObserver.disconnect(),t.innerHTML="";const s=n.terminal.element;if(s?t.appendChild(s):n.terminal.open(t),t.addEventListener("paste",e=>{if(!e.target.classList.contains("xterm-helper-textarea"))return;const t=e.clipboardData?.getData("text");if(t&&n.ws?.readyState===WebSocket.OPEN){const s=32768;if(t.length>s){e.preventDefault();const i=[];for(let e=0;e<t.length;e+=s)i.push(t.slice(e,e+s));let o=0;const r=()=>{o<i.length&&n.ws?.readyState===WebSocket.OPEN&&(n.ws.send(JSON.stringify({type:"input",data:i[o]})),o++,o<i.length&&setTimeout(r,10))};r()}}}),n.terminal.refresh(0,n.terminal.rows-1),window.ResizeObserver){let n=null;const s=new ResizeObserver(()=>{n&&clearTimeout(n),n=setTimeout(()=>{this.fitSession(e)},50)});s.observe(t),k(e,e=>({...e,resizeObserver:s}))}requestAnimationFrame(()=>{this.fitSession(e),n.terminal.focus()})},writeToSession(e,t){const n=A().sessions.get(e);n&&n.terminal.write(t)},writeLineToSession(e,t){const n=A().sessions.get(e);n&&n.terminal.writeln(t)},getSessionByContainerId(e){const t=A();return Array.from(t.sessions.values()).find(t=>t.containerId===e)},hasActiveSession(e){return!!this.getSessionByContainerId(e)},getActiveContainerId(){const e=A();if(!e.activeSessionId)return null;const t=e.sessions.get(e.activeSessionId);return t?.containerId||null},detachSession(e,t,n){const s=A(),i=s.sessions.get(e);if(!i||i.isDetached)return;const o=t??s.floatingPosition.x+50,r=n??s.floatingPosition.y+50,a=s.topZIndex+1;if(P(e=>({...e,topZIndex:a})),k(e,e=>({...e,isDetached:!0,detachedPosition:{x:o,y:r},detachedSize:{width:600,height:400},detachedZIndex:a})),s.activeSessionId===e){const t=Array.from(s.sessions.values()).filter(t=>t.id!==e&&!t.isDetached);P(e=>({...e,activeSessionId:t.length>0?t[0].id:null}))}requestAnimationFrame(()=>this.fitSession(e))},bringToFront(e){const t=A(),n=t.sessions.get(e);if(n&&n.isDetached&&n.detachedZIndex<t.topZIndex){const n=t.topZIndex+1;P(e=>({...e,topZIndex:n})),k(e,e=>({...e,detachedZIndex:n}))}},attachSession(e){const t=A().sessions.get(e);t&&t.isDetached&&(k(e,e=>({...e,isDetached:!1})),P(t=>({...t,activeSessionId:e,isMinimized:!1})),requestAnimationFrame(()=>this.fitSession(e)))},setDetachedPosition(e,t,n){k(e,e=>({...e,detachedPosition:{x:t,y:n}}))},setDetachedSize(e,t,n){k(e,e=>({...e,detachedSize:{width:t,height:n}}))},sendCtrlC(e){const t=A().sessions.get(e);t&&t.ws&&t.ws.readyState===WebSocket.OPEN&&t.ws.send(JSON.stringify({type:"input",data:""}))},sendInput(e,t){const n=A().sessions.get(e);n&&n.ws&&n.ws.readyState===WebSocket.OPEN&&n.ws.send(JSON.stringify({type:"input",data:t}))},navigateSplitPanes(e,t){const n=A().sessions.get(e);if(!n||!n.splitLayout||0===n.splitPanes.size)return;const s=n.activePaneId||"main",i=n.splitLayout,o=i.panes,r=o.indexOf(s);if(-1===r)return;let a=r;"horizontal"===i.direction?"left"===t?a=(r-1+o.length)%o.length:"right"===t&&(a=(r+1)%o.length):"up"===t?a=(r-1+o.length)%o.length:"down"===t&&(a=(r+1)%o.length);const c=o[a];c&&c!==s&&(k(e,e=>({...e,activePaneId:c})),requestAnimationFrame(()=>{if("main"===c)n.terminal.focus();else{const e=n.splitPanes.get(c);e?.terminal.focus()}}))},_generatePaneId:()=>`pane-${Date.now()}-${Math.random().toString(36).slice(2,7)}`,async splitPane(e,t="horizontal"){if(!A().sessions.get(e))return null;if(!c(r))return null;let i,o,a,l,d,u;try{({Terminal:i,FitAddon:o,Unicode11Addon:a,WebLinksAddon:l}=await n())}catch(g){return s.error("Failed to open split pane. Please try again."),null}try{d=new i({...S,theme:w()}),u=new o,d.loadAddon(u),d.loadAddon(new l);const e=new a;d.loadAddon(e),d.unicode.activeVersion="11",d.attachCustomKeyEventHandler(f(d))}catch(g){return s.error("Failed to open split pane. Please try again."),null}const m=this._generatePaneId(),p={id:m,sessionId:e,terminal:d,fitAddon:u,webglAddon:null,resizeObserver:null,ws:null,status:"connecting",reconnectAttempts:0,reconnectTimer:null};return k(e,e=>{const n=new Map(e.splitPanes);n.set(m,p);let s=e.splitLayout;if(s)if(s.direction===t){const e=100/(s.panes.length+1);s={...s,panes:[...s.panes,m],sizes:s.sizes.map(()=>e).concat([e])}}else{const e=100/(s.panes.length+1);s={direction:t,panes:[...s.panes,m],sizes:s.sizes.map(()=>e).concat([e])}}else s={direction:t,panes:["main",m],sizes:[50,50]};return{...e,splitPanes:n,splitLayout:s,activePaneId:m}}),this.connectSplitPaneWebSocket(e,m),m},connectSplitPaneWebSocket(e,n){const s=A().sessions.get(e);if(!s)return;const i=s.splitPanes.get(n);if(!i)return;const o=c(r);if(!o)return;if(i.ws&&(i.ws.readyState===WebSocket.OPEN||i.ws.readyState===WebSocket.CONNECTING))return;i.reconnectTimer&&clearTimeout(i.reconnectTimer),k(e,e=>{const t=new Map(e.splitPanes),s=t.get(n);return s&&t.set(n,{...s,status:"connecting"}),{...e,splitPanes:t}});const a=s.agentId||(s.containerId.startsWith("agent:")?s.containerId.slice(6):null);let l;if(s.isAgentSession||a){if(!a)return;l=`${I()}/ws/agent/${encodeURIComponent(a)}/terminal?id=${encodeURIComponent(n)}&newSession=true`}else l=`${I()}/ws/terminal/${encodeURIComponent(s.containerId)}?id=${encodeURIComponent(n)}&newSession=true`;const u=t(l,o);u.onopen=()=>{k(e,e=>{const t=new Map(e.splitPanes),s=t.get(n);return s&&t.set(n,{...s,status:"connected",reconnectAttempts:0}),{...e,splitPanes:t}}),u.send(JSON.stringify({type:"resize",cols:i.terminal.cols,rows:i.terminal.rows})),i.terminal.writeln("[32mâ€º Split session connected[0m\r\n")};let f="",m=null,p=null,g=0;const h=e=>{let t=e.replace(/\x1b\[<\d+;\d+;\d+[Mm]/g,"");return t=t.replace(/\x1b\]\d+;[^\x07\x1b]*(?:\x07|\x1b\\)/g,""),t=t.replace(/\]\d+;rgb:[0-9a-f/]+/gi,""),t},w=()=>{if(f&&i.terminal){const e=h(f);e&&i.terminal.write(e),f="",g=performance.now()}m=null,p=null},S=()=>{if(m)return;performance.now()-g>8?(p=requestAnimationFrame(()=>{m&&(clearTimeout(m),m=null),w()}),m=setTimeout(()=>{p&&(cancelAnimationFrame(p),p=null),w()},50)):m=setTimeout(()=>{w()},8)};u.onmessage=async t=>{let s=t.data;s instanceof Blob&&(s=await s.text());try{const t=JSON.parse(s);if("output"===t.type){const e=t.data;if(e.length<=256)return void(e=>{if(i.terminal){const t=h(e);t&&i.terminal.write(t)}})(e);f+=e,f.length>=d?(m&&clearTimeout(m),p&&cancelAnimationFrame(p),w()):S()}else"error"===t.type?i.terminal.writeln(`\r\n[31mError: ${t.data}[0m`):"ping"===t.type?u.send(JSON.stringify({type:"pong"})):"shell_ready"!==t.type&&"shell_started"!==t.type||k(e,e=>{const t=new Map(e.splitPanes),s=t.get(n);return s&&t.set(n,{...s,status:"connected"}),{...e,splitPanes:t}})}catch{f+=s,f.length>=d?(m&&clearTimeout(m),p&&cancelAnimationFrame(p),w()):S()}},u.onclose=t=>{const s=A().sessions.get(e);if(!s)return;const o=s.splitPanes.get(n);if(!o)return;const r=1e3===t.code,a=t.code>=4e3,c=o.reconnectAttempts>=15;if(!r&&!a&&!c){const t=o.reconnectAttempts+1,s=100,r=1===t?0:Math.min(s*Math.pow(1.5,o.reconnectAttempts-1),8e3);k(e,e=>{const s=new Map(e.splitPanes),i=s.get(n);return i&&s.set(n,{...i,status:"connecting",reconnectAttempts:t}),{...e,splitPanes:s}}),t>3&&i.terminal.writeln(`\r\n[33mâŸ³ Split session reconnecting (${t}/15)...[0m`);const a=setTimeout(()=>{this.connectSplitPaneWebSocket(e,n)},r);k(e,e=>{const t=new Map(e.splitPanes),s=t.get(n);return s&&t.set(n,{...s,reconnectTimer:a}),{...e,splitPanes:t}})}else k(e,e=>{const t=new Map(e.splitPanes),s=t.get(n);return s&&t.set(n,{...s,status:a?"error":"disconnected"}),{...e,splitPanes:t}}),a?i.terminal.writeln("\r\n[31mâœ– Split session ended. Terminal may have been stopped or removed.[0m"):c?i.terminal.writeln("\r\n[31mâœ– Split session connection lost after multiple attempts.[0m"):i.terminal.writeln("\r\n[33mâ€º Split session disconnected[0m")},u.onerror=()=>{},i.terminal.onData(e=>{u.readyState===WebSocket.OPEN&&u.send(JSON.stringify({type:"input",data:e}))}),i.ws=u,k(e,e=>{const t=new Map(e.splitPanes);return t.set(n,i),{...e,splitPanes:t}})},closeSplitPane(e,t){const n=A().sessions.get(e);if(!n)return;const s=n.splitPanes.get(t);s&&(s.reconnectTimer&&clearTimeout(s.reconnectTimer),s.ws&&s.ws.close(),s.resizeObserver&&s.resizeObserver.disconnect(),s.webglAddon&&s.webglAddon.dispose(),s.terminal&&s.terminal.dispose(),k(e,e=>{const n=new Map(e.splitPanes);n.delete(t);let s=e.splitLayout;if(s){const e=s.panes.indexOf(t);if(-1!==e){const n=s.panes.filter(e=>e!==t);if(n.length<=1)s=null;else{const t=s.sizes.filter((t,n)=>n!==e),i=t.reduce((e,t)=>e+t,0);s={...s,panes:n,sizes:t.map(e=>e/i*100)}}}}return{...e,splitPanes:n,splitLayout:s,activePaneId:e.activePaneId===t?null:e.activePaneId}}))},setActivePaneId(e,t){k(e,e=>({...e,activePaneId:t}))},attachSplitPane(t,n,s){const i=A().sessions.get(t);if(!i)return;const o=i.splitPanes.get(n);if(o&&s){if(o.resizeObserver&&o.resizeObserver.disconnect(),o.terminal.open(s),e().then(({WebglAddon:e})=>{const s=A().sessions.get(t),i=s?.splitPanes.get(n);if(i&&!i.webglAddon)try{const t=new e;t.onContextLoss(()=>t.dispose()),i.terminal.loadAddon(t),i.webglAddon=t}catch(o){}}).catch(()=>{}),window.ResizeObserver){let e=null;const i=new ResizeObserver(()=>{e&&clearTimeout(e),e=setTimeout(()=>{this.fitSplitPane(t,n)},50)});i.observe(s),o.resizeObserver=i}requestAnimationFrame(()=>this.fitSplitPane(t,n))}},fitSplitPane(e,t){const n=A().sessions.get(e);if(!n)return;const s=n.splitPanes.get(t);if(s)try{s.fitAddon.fit()}catch(i){}},setSplitPaneSizes(e,t){k(e,e=>e.splitLayout?{...e,splitLayout:{...e.splitLayout,sizes:t}}:e)},toggleSplitDirection(e){k(e,e=>e.splitLayout?{...e,splitLayout:{...e.splitLayout,direction:"horizontal"===e.splitLayout.direction?"vertical":"horizontal"}}:e),requestAnimationFrame(()=>{const t=A().sessions.get(e);t&&(this.fitSession(e),t.splitPanes.forEach((t,n)=>{this.fitSplitPane(e,n)}))})}}}();if("undefined"!=typeof window){let e;window.addEventListener("resize",()=>{clearTimeout(e),e=setTimeout(()=>{P.updateFontSize()},150)}),window.addEventListener("keydown",e=>{(e.metaKey||e.ctrlKey)&&("+"===e.key||"="===e.key?(e.preventDefault(),P.zoomIn()):"-"===e.key?(e.preventDefault(),P.zoomOut()):"0"===e.key&&(e.preventDefault(),P.resetZoom()))})}const A=l(P,e=>e.activeSessionId?e.sessions.get(e.activeSessionId):null),k=l(P,e=>e.sessions.size),z=l(P,e=>e.sessions.size>0),O=l(P,e=>{const t=new Set,n=Array.from(e.sessions.values());for(const s of n)"connected"!==s.status&&"connecting"!==s.status||t.add(s.containerId);return t});function T(e){const t=c(P);for(const n of t.sessions.values())if(n.containerId===e&&("connected"===n.status||"connecting"===n.status))return!0;return!1}const M=l(P,e=>"floating"===e.viewMode),x=l(P,e=>"docked"===e.viewMode),C=l(P,e=>"fullscreen"===e.viewMode);export{A as activeSession,O as connectedContainerIds,z as hasSessions,T as isContainerConnected,x as isDocked,M as isFloating,C as isFullscreen,k as sessionCount,P as terminal};
