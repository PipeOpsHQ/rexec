import{w as e,g as s,d as t}from"./svelte-V7cO9hUs.js";import{a as o}from"./index-CRn00pAv.js";import"./vendor-CPGM4lnp.js";const i={enabled:!1,isLocked:!1,lockAfterMinutes:5,lastActivity:Date.now(),passcodeSetupPromptDismissed:!1,singleSessionMode:!1};const r=function(){const t=e(function(){if("undefined"==typeof window)return i;try{const e=localStorage.getItem("rexec_security");if(e){const s=JSON.parse(e);return{...i,isLocked:!0===s.isLocked,lockAfterMinutes:s.lockAfterMinutes||5,lastActivity:s.lastActivity||Date.now(),passcodeSetupPromptDismissed:s.passcodeSetupPromptDismissed||!1,singleSessionMode:s.singleSessionMode||!1}}}catch(e){}return i}()),{subscribe:r,update:c}=t;function n(e){"undefined"!=typeof window&&localStorage.setItem("rexec_security",JSON.stringify({isLocked:e.isLocked,lockAfterMinutes:e.lockAfterMinutes,lastActivity:e.lastActivity,passcodeSetupPromptDismissed:e.passcodeSetupPromptDismissed,singleSessionMode:e.singleSessionMode}))}async function a(e,t={}){const i=s(o).token||localStorage.getItem("rexec_token"),r=new Headers(t.headers||{});return r.set("Content-Type","application/json"),i&&r.set("Authorization",`Bearer ${i}`),fetch(e,{...t,headers:r})}return{subscribe:r,async refreshFromServer(){const e=await a("/api/security");if(423===e.status)return void c(e=>{const s={...e,isLocked:!0};return n(s),s});if(!e.ok)return;const s=await e.json();c(e=>{const t={...e,enabled:!!s.enabled,isLocked:!1,lockAfterMinutes:s.lock_after_minutes||e.lockAfterMinutes,singleSessionMode:!!s.single_session_mode};return n(t),t})},async setPasscode(e,s,t){const o=await a("/api/security/passcode",{method:"POST",body:JSON.stringify({new_passcode:e,current_passcode:s,lock_after_minutes:t})});if(423===o.status)return this.lockLocal(),{success:!1,error:"session_locked"};const i=await o.json().catch(()=>({}));return o.ok?(c(e=>{const s={...e,enabled:!0,lockAfterMinutes:i.lock_after_minutes||e.lockAfterMinutes};return n(s),s}),{success:!0}):{success:!1,error:i.error||"Failed to set passcode"}},async removePasscode(e){const s=await a("/api/security/passcode",{method:"DELETE",body:JSON.stringify({current_passcode:e})});if(423===s.status)return this.lockLocal(),{success:!1,error:"session_locked"};const t=await s.json().catch(()=>({}));return s.ok?(c(e=>{const s={...e,enabled:!1,isLocked:!1};return n(s),s}),{success:!0}):{success:!1,error:t.error||"Failed to disable screen lock"}},async updateLockTimeout(e){const s=await a("/api/security",{method:"PATCH",body:JSON.stringify({lock_after_minutes:e})});if(423===s.status)return this.lockLocal(),{success:!1,error:"session_locked"};const t=await s.json().catch(()=>({}));return s.ok?(c(s=>{const t={...s,lockAfterMinutes:e};return n(t),t}),{success:!0}):{success:!1,error:t.error||"Failed to update lock timeout"}},async lock(){const e=await a("/api/security/lock",{method:"POST"});(e.ok||423===e.status)&&this.lockLocal()},lockLocal(){c(e=>{const s={...e,isLocked:!0};return n(s),s})},async unlockWithPasscode(e){const t=await a("/api/security/unlock",{method:"POST",body:JSON.stringify({passcode:e})}),i=await t.json().catch(()=>({}));if(!t.ok)return{success:!1,error:i.error||"Incorrect passcode"};const r=i.token;if(r){const e=s(o);e.user?o.login(r,{...e.user,tier:i.user?.tier??e.user.tier,isAdmin:i.user?.is_admin??e.user.isAdmin,subscriptionActive:i.user?.subscription_active??e.user.subscriptionActive,allowedIPs:i.user?.allowed_ips??e.user.allowedIPs,mfaEnabled:i.user?.mfa_enabled??e.user.mfaEnabled}):i.user&&o.login(r,{id:i.user.id,email:i.user.email,username:i.user.username,name:i.user.username,tier:i.user.tier,isGuest:"guest"===i.user.tier,isAdmin:i.user.is_admin,subscriptionActive:i.user.subscription_active,allowedIPs:i.user.allowed_ips||[],mfaEnabled:i.user.mfa_enabled||!1})}return c(e=>{const s={...e,isLocked:!1,lastActivity:Date.now()};return n(s),s}),{success:!0}},updateActivity(){c(e=>{const s={...e,lastActivity:Date.now()};if("undefined"!=typeof window){const e=window.__rexec_last_activity_persist||0,t=Date.now();t-e>3e4&&(n(s),window.__rexec_last_activity_persist=t)}return s})},dismissSetupPrompt(){c(e=>{const s={...e,passcodeSetupPromptDismissed:!0};return n(s),s})},resetSetupPrompt(){c(e=>{const s={...e,passcodeSetupPromptDismissed:!1};return n(s),s})},async setSingleSessionMode(e){const s=await a("/api/security/single-session",{method:"POST",body:JSON.stringify({enabled:e})});if(!s.ok){return{success:!1,error:(await s.json().catch(()=>({}))).error||"Failed to update setting"}}return c(s=>{const t={...s,singleSessionMode:e};return n(t),t}),{success:!0}},checkInactivity(){const e=s(t);if(!e.enabled||e.isLocked)return!1;return Date.now()-e.lastActivity>=60*e.lockAfterMinutes*1e3},getState:()=>s(t)}}(),c=t(r,e=>e.enabled),n=t(r,e=>e.isLocked);t(r,e=>!e.enabled&&!e.passcodeSetupPromptDismissed);export{c as hasPasscode,n as isLocked,r as security};
