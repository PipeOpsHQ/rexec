import{w as e,g as t}from"./svelte-V7cO9hUs.js";import{a as n}from"./index-CRn00pAv.js";const s="/api";const a=function(){const{subscribe:a,set:o,update:r}=e({agents:[],loading:!1,error:null,agentTokens:{}});function i(){const e=t(n);return e.token?{Authorization:`Bearer ${e.token}`}:{}}return{subscribe:a,async fetchAgents(){r(e=>({...e,loading:!0,error:null}));try{const e=await fetch(`${s}/agents`,{headers:i()});if(!e.ok)throw new Error("Failed to fetch agents");const t=await e.json(),n=await Promise.all((t||[]).map(async e=>{if("online"===e.status)try{const t=await fetch(`${s}/agents/${e.id}/status`,{headers:i()});if(t.ok){const n=await t.json();return{...e,system_info:n.system_info,stats:n.stats}}}catch{}return e}));r(e=>({...e,agents:n,loading:!1}))}catch(e){r(t=>({...t,error:e.message,loading:!1}))}},async registerAgent(e,t){r(e=>({...e,loading:!0,error:null}));try{const n=await fetch(`${s}/agents/register`,{method:"POST",headers:{...i(),"Content-Type":"application/json"},body:JSON.stringify({name:e,description:t})});if(!n.ok)throw new Error("Failed to register agent");const a=await n.json();return r(e=>({...e,agents:[{...a,status:"registered"},...e.agents],loading:!1,agentTokens:a.token?{...e.agentTokens,[a.id]:a.token}:e.agentTokens})),a}catch(n){return r(e=>({...e,error:n.message,loading:!1})),null}},async deleteAgent(e){try{if(!(await fetch(`${s}/agents/${e}`,{method:"DELETE",headers:i()})).ok)throw new Error("Failed to delete agent");return r(t=>({...t,agents:t.agents.filter(t=>t.id!==e)})),!0}catch(t){return r(e=>({...e,error:t.message})),!1}},getToken:()=>t(n).token||"",getInstallScript(e){const s=t({subscribe:a}).agentTokens[e]||t(n).token||"";return`curl -sSL ${window.location.origin}/install-agent.sh | sudo bash -s -- --agent-id ${e} --token ${s}`},getAgentToken:e=>t({subscribe:a}).agentTokens[e],updateAgentStatus(e,t,n){r(s=>({...s,agents:s.agents.map(s=>s.id===e?{...s,status:t,...n?.system_info&&{system_info:n.system_info},...n?.stats&&{stats:n.stats},...n?.connected_at&&{connected_at:n.connected_at},...n?.os&&{os:n.os},...n?.arch&&{arch:n.arch},...n?.shell&&{shell:n.shell}}:s)}))},reset(){o({agents:[],loading:!1,error:null,agentTokens:{}})}}}();"undefined"!=typeof window&&(window.addEventListener("container-agent-connected",e=>{const t=e.detail.id?.replace("agent:","");t&&a.updateAgentStatus(t,"online",e.detail)}),window.addEventListener("container-agent-disconnected",e=>{const t=e.detail.id?.replace("agent:","");t&&a.updateAgentStatus(t,"offline")}));export{a};
